<template>
  <q-page class="q-pa-md-xl q-pa-none-xs">

    <q-input
      autofocus=""
      input-class=" text-transparent text-h3 text-bold text-center"
      v-model="testtester"
      mask="#### - ####"
      color="blue"
      style="width:10px;"
      class=" text-weight-bold dense"
      ref="dummytester"
    />
    <div
      v-if="!showStudInfo"
      class=" text-center text-bold text-h2 q-mb-lg"
    >

      <div class="text-center">
        <div
          @click="onDecode"
          class="text-bold text-h1 "
          style="font-size:130px;font-family: 'Marko One', serif;"
        >
          Login
          <span>üòç</span>
          <!-- <q-separator inset></q-separator> -->
          <q-chip
            square
            class="text-h3 text-bold q-pa-xl q-mt-xl"
            color="transparent"
          >
            <span>
              <q-icon
                color="red-10"
                size="70px"
                class="q-mr-sm"
                name="alarm"
              />
            </span>
            <span class="text-blue-10">
              {{now.date + ' ' + now.time}}
            </span>

          </q-chip>
        </div>

        <q-card>
          <q-card-section>
            <div class="text-h6 text-weight-bold text-left">
              Students with Penalties ü§™ ü§™
            </div>
          </q-card-section>
          <q-separator />
          <q-card-actions>
            <div>
              <q-item>
                <q-item-section avatar>
                  <q-avatar size="100px">
                    <img src="https://scontent.fceb2-2.fna.fbcdn.net/v/t1.0-9/58781442_101475567741762_3954632107485036544_n.jpg?_nc_cat=110&_nc_oc=AQkVpGiF93SJv9jd6nvGnJVqFnq3d0Ks1KbIIHzZTHcoQobw4Sy04L0PNrz6vCNq4SM&_nc_ht=scontent.fceb2-2.fna&oh=3174be1e1bb7feb3b43780b5c7662bb5&oe=5E5A2A70">
                  </q-avatar>
                </q-item-section>

                <q-item-section>
                  <q-item-label class="text-h4 text-bold "> Dela Cruz, Cheri Joy J.
                    <q-badge
                      color="red"
                      style="margin-left:100px"
                    >
                      <span class="text-h6"> ‚Ç± 200</span>
                    </q-badge>
                  </q-item-label>
                  <q-item-label class="text-left text-h5 text-blue text-weight-bold">Education</q-item-label>
                </q-item-section>
              </q-item>
            </div>
            <div>
              <q-item>
                <q-item-section avatar>
                  <q-avatar size="100px">
                    <img
                      src="https://scontent.fceb2-1.fna.fbcdn.net/v/t1.0-9/53900809_586019058539085_7805194322709577728_n.jpg?_nc_cat=108&_nc_oc=AQmtM7cJTytH4CsLBN5SHdin4LR8MSOG-qDOsABhOzZW4BJqvd5HxcmK3yGTGp8Eiek&_nc_ht=scontent.fceb2-1.fna&oh=7461b6375fdf4c1179e0bb6970fd8c10&oe=5E6323CA"
                      alt=""
                    >
                  </q-avatar>
                </q-item-section>

                <q-item-section>
                  <q-item-label class="text-h4 text-bold"> Dinawanao, Jessa
                    <q-badge
                      color="red"
                      style="margin-left:170px"
                    >
                      <span class="text-h6"> ‚Ç± 150</span>
                    </q-badge>
                  </q-item-label>
                  <q-item-label class="text-left text-h5 text-purple text-weight-bold">Criminology</q-item-label>
                </q-item-section>

              </q-item>
            </div>
            <div>
              <q-item>
                <q-item-section avatar>
                  <q-avatar size="100px">
                    <img src="https://scontent.fceb2-1.fna.fbcdn.net/v/t1.0-9/53489201_1147368018771305_5891788552710127616_n.jpg?_nc_cat=103&_nc_oc=AQltQVibE-BFxzktOGPJV2n2kcP3jC2_i8jniqpjPnsoQvlIp-xNlorDYPgRdBA6XA0&_nc_ht=scontent.fceb2-1.fna&oh=23d8403c25ece2e8fd0a2a7ef47d2058&oe=5E5F262B">
                  </q-avatar>
                </q-item-section>

                <q-item-section>
                  <q-item-label class="text-h4 text-bold"> Cabando, Novenal A.
                    <q-badge
                      color="red"
                      style="margin-left:125px"
                    >
                      <span class="text-h6"> ‚Ç± 300</span>
                    </q-badge>
                  </q-item-label>
                  <q-item-label class="text-left text-h5 text-blue text-weight-bold">Education</q-item-label>
                </q-item-section>
              </q-item>
            </div>

            <div>
              <q-item>
                <q-item-section avatar>
                  <q-avatar size="100px">
                    <img
                      src="https://scontent.fceb2-1.fna.fbcdn.net/v/t1.0-9/20258409_131084840825149_2509340819057488918_n.jpg?_nc_cat=111&_nc_oc=AQkjguTeHGpF501Gg6qqbAsxQfbp2o-czM521kzVJeWm5QdK08vxZtQu51ymle1DJew&_nc_ht=scontent.fceb2-1.fna&oh=1346c23a4267445b3af0139aea5421f0&oe=5E2AE18F"
                      alt=""
                    >
                  </q-avatar>
                </q-item-section>

                <q-item-section>
                  <q-item-label class="text-h4 text-bold"> Galenzoga, Jomal Mark
                    <q-badge
                      color="red"
                      style="margin-left:83px"
                    >
                      <span class="text-h6"> ‚Ç± 100</span>
                    </q-badge>
                  </q-item-label>
                  <q-item-label class="text-left text-h5 text-blue text-weight-bold">Education</q-item-label>
                </q-item-section>

              </q-item>
            </div>

            <!-- <ol class="text-h4 text-bold text-left">
              <li class="text-blue-10 text-h6">

                Dela Cruz, Cheri Joy J. --- <span class="text-red text-bold">‚Ç± 200 </span>

              </li>
              <li class="text-purple-10 text-h6">Dinawanao, Jessa --- <span class="text-red text-bold">‚Ç± 150</span></li>
            </ol> -->
          </q-card-actions>
        </q-card>

      </div>

    </div>

    <div
      v-if="showStudInfo"
      @click="onDecode()"
      class="text-center text-bold text-h2 q-mb-lg"
      style="font-family: 'Marko One', serif;"
    >
      Library Statistics
      <span>üìà</span>
      <q-separator
        inset
        spaced=""
      ></q-separator>
    </div>

    <transition
      enter-active-class="animated rotateIn"
      leave-active-class="animated zoomOut"
    >
      <q-card
        v-if="showStudInfo"
        bordered
        class="col-9 q-pa-lg q-mt-xl row shadow-1"
      >
        <div class="full-width row wrap justify-center items-center content-center">
          <div class="col-md-6 col-sm-12 row justify-center items-center content-center">
            <q-circular-progress
              show-value
              font-size="10px"
              class="q-ma-md"
              :value="65"
              size="320px"
              :thickness="0.25"
              color="transparent"
              track-color="transparent"
            >
              <q-avatar
                class="shadow-3"
                size="300px"
              >
                <img :src="studentInformationForm.profileImgUrl">
              </q-avatar>
            </q-circular-progress>
          </div>
          <div class="col-md-6 col-sm-12">
            <div class="text-h4 text-bold">
              Welcome
            </div>
            <div class="text-h3 text-bold text-capitalize">
              {{studentInformationForm.firstname + ' ' + studentInformationForm.surname}}
            </div>
            <q-separator
              inset
              spaced
            ></q-separator>
            <div class="text-h2 text-bold text-primary">
              {{studentInformationForm.idnumber}}
            </div>
            <div class="text-h5 text-bold">{{studentInformationForm.course}}</div>

          </div>
        </div>
      </q-card>
    </transition>

    <qrcodereader
      @onInit="onInit"
      @onDecode="onDecode"
      :result.sync="result"
      :error.sync="error"
      v-if="showstream"
    />

    <q-dialog v-model="dialogIdtyper">
      <q-card
        style="width:500px"
        class="q-pa-lg"
      >
        <q-toolbar>
          <q-avatar square>
            <img src="https://img.icons8.com/ios-filled/50/000000/security-pass.png">
          </q-avatar>

          <q-toolbar-title class="text-h6">Enter your <span class="text-weight-bold ">ID NUMBER</span> </q-toolbar-title>

        </q-toolbar>

        <q-card-section>
          <q-input
            autofocus=""
            input-class="text-h3 text-bold text-center"
            standout="bg-primary text-white"
            v-model="test"
            mask="#### - ####"
            class="text-weight-bold "
          />

        </q-card-section>
      </q-card>
    </q-dialog>

    <!-- <img src="https://firebasestorage.googleapis.com/v0/b/einstein00-cf6cc.appspot.com/o/images%2F2ynRormG3d7cNXJKZoV3?alt=media&token=f48ac41b-c87d-48dd-9f25-9dd1226d2a56"> -->

  </q-page>
</template>

<script>
import { mapGetters, mapActions } from 'vuex'
import find from 'lodash/find'
import replace from 'lodash/replace'
import { date } from 'quasar'
// import moment from 'moment'

export default {
  components: {
    'qrcodereader': require('components/qrcodeReader/qrcodereader1.vue').default
    // 'libraryQrLoginCarousel': require('components/carousel/libraryQrcodelogin.vue').default
  },
  data () {
    return {
      slide: 1,
      test: '',
      testtester: '',
      showstream: false,
      now: {
        time: '',
        date: '',
        local: ''
      },
      result: '',
      error: '',
      value: 50,
      dialog1: true,
      showStudInfo: false,
      studentInformationForm: {
        firstname: '',
        middlename: '',
        surname: '',
        idnumber: '',
        keyIndex: '',
        course: '',
        profileImgUrl: '',
        fullname: ''
      }
    }
  },
  computed: {
    ...mapGetters('admin', ['studentLists2']),
    dialogIdtyper () {
      let dialog = Boolean
      // let vm = this
      if (this.testtester !== '') {
        // vm.testtester = vm.test
        dialog = true
        if (dialog === false) {
          console.log(this.$refs.dummytester.focus())
        }
      } else if (this.test === '') {
        dialog = false
      }
      return dialog
    }
  },
  methods: {
    ...mapActions('admin', ['addLibraryStat']),
    eventTake (event) {
      console.log(event)
    },
    showNotif (data) {
      var take0 = data[0]
      this.$q.notify({
        color: take0.color,
        textColor: 'white',
        multiline: true,
        timeout: 1500,
        html: true,
        message: take0.message,
        avatar: 'https://cdn.quasar.dev/img/boy-avatar.png'
      })
    },
    addStat (data) {
      let vm = this
      let createdInfo = {
        idnumber: this.studentInformationForm.keyIndex,
        time: this.now
      }
      this.addLibraryStat(createdInfo).then(function (result) {
        var options = []
        options.push({
          message: `Successfully Login, <br> <span class="text-capitalize">Have a nice day ${data.firstname}! </span> `,
          color: 'light-green-8'
        })

        setTimeout(function () {
          vm.showStudInfo = false
          vm.studentInformationForm = {
            firstname: '',
            middlename: '',
            surname: '',
            idnumber: '',
            keyIndex: '',
            course: '',
            profileImgUrl: ''
          }
        }, 5000)

        vm.showNotif(options)
      }, function (error) {
        console.log(error)
      })
    },
    DecodeSuccess (data) {
      this.showStudInfo = true
      this.studentInformationForm = {
        firstname: data.firstname,
        middlename: data.middlename,
        surname: data.surname,
        idnumber: data.idnumber,
        keyIndex: data.keyIndex,
        course: data.course,
        profileImgUrl: data.profileImgUrl
      }

      this.addStat(data)
    },
    DecodeError () {
      console.log('error')
      // var audioerror = new Audio('/statics/ringtone/suspense-message-2.mp3')
      // audioerror.play()
    },
    onDecode (result) {
      result = 'PHOJIEMONEX - 2019 - 0310'
      this.showStudInfo = false

      this.result = result
      var idNUmber = replace(this.result, 'PHOJIEMONEX - ', '')
      var indexData = find(this.studentLists2, ['idnumber', idNUmber])
      // alert(idNUmber, indexData)
      if (indexData !== undefined) {
        // alert(idNUmber)
        // console.log(indexData)
        // var sound = '/statics/ringtone/notification.mp3'
        var audio = new Audio('/statics/ringtone/notification.mp3')
        audio.play()
        this.DecodeSuccess(indexData)
      } else {
        this.DecodeError()
      }
      // console.log(indexData)
      // console.log(this.studentLists2)
    },

    async onInit (promise) {
      try {
        await promise
      } catch (error) {
        if (error.name === 'NotAllowedError') {
          this.error = 'ERROR: you need to grant camera access permisson'
        } else if (error.name === 'NotFoundError') {
          this.error = 'ERROR: no camera on this device'
        } else if (error.name === 'NotSupportedError') {
          this.error = 'ERROR: secure context required (HTTPS, localhost)'
        } else if (error.name === 'NotReadableError') {
          this.error = 'ERROR: is the camera already in use?'
        } else if (error.name === 'OverconstrainedError') {
          this.error = 'ERROR: installed cameras are not suitable'
        } else if (error.name === 'StreamApiNotSupportedError') {
          this.error = 'ERROR: Stream API is not supported in this browser'
        }
      } finally {
        // hide loading
      }
    }
  },
  created () {
    let vm = this
    setInterval(function () {
      let timeStamp = new Date()
      let local = timeStamp.setHours(timeStamp.getHours() - 1)
      // .SSSZ
      let formattedTime = date.formatDate(local, 'hh:mm:ssa')
      let formattedDate = date.formatDate(local, 'MMMM Do YYYY')
      vm.now.time = formattedTime
      vm.now.date = formattedDate
      vm.now.local = local
      // let date1 = new Date(1570222200202)
      // let date2 = date.formatDate(date1, 'hh:mm:ssa')
      // console.log(date2)
    }, 1000)
  }
}
</script>

<style lang="stylus">
.bgPh {
  background-size: cover;
  background-repeat: no-repeat;
  background-image: url('https://cdn-images-1.medium.com/max/800/1*hTwl4OGQJtoR3yOSYXCmmg.gif');
}

.my-card {
  width: 100%;
  max-width: 250px;
}
</style>
